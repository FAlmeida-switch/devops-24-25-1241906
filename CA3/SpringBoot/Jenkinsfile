// Jenkinsfile for the Spring Boot Application pipeline

pipeline {
    agent {
        docker {
            image 'jenkins/inbound-agent:jdk17'
        }
    }

    // 2. Define tools that Jenkins should provide (like Gradle)
    tools {
        gradle 'gradle_latest' // <--- REPLACE 'gradle_latest' with the exact name you configured in Jenkins
    }

    stages {
        stage('Checkout Source Code') {
            steps {
                echo 'Checking out Spring Boot application from remote Repository...'
                git branch: 'main', url: 'https://github.com/FAlmeida-switch/devops-24-25-1241906.git'
            }
        }

        // 3. Combine Assemble (including Frontend) and potentially Build into one stage
        stage('Assemble Spring Boot Frontend and Backend') {
            steps {
                dir('CA1/part3/react-and-spring-data-rest-basic') {
                    echo 'Assembling Spring Boot project (including frontend with Gradle plugin)...'
                    sh 'chmod +x gradlew'
                    sh './gradlew clean assemble'
                }
            }
        }

        // 4. The 'Build Spring Boot' stage is somewhat redundant if 'assemble' successfully
        // builds the JAR. You can remove this stage if 'assemble' creates the final JAR.
        stage('Build Spring Boot (Optional - usually handled by assemble)') {
            steps {
                dir('CA1/part3/react-and-spring-data-rest-basic') {
                    echo 'Building Spring Boot project (if not already done by assemble)...'
                    sh './gradlew build'
                }
            }
        }

        stage('Test Spring Boot') {
            steps {
                dir('CA1/part3/react-and-spring-data-rest-basic') {
                    echo 'Executing J-unit Tests for Spring Boot...'
                    sh './gradlew test'
                    junit 'build/test-results/test/*.xml'
                }
            }
        }

        // Docker Stages (These look mostly fine, assuming paths are correct)
        stage('Build Docker Image') {
            steps {
                script {
                    echo 'Copying JAR to Docker build context...'
                    def springBootProjectDir = 'CA1/part3/react-and-spring-data-rest-basic'
                    def dockerBuildDir = 'CA3/SpringBoot' // Where my Dockerfile is located

                    // Add a check to ensure the JAR exists before copying
                    sh "test -f ${springBootProjectDir}/build/libs/react-and-spring-data-rest-basic-0.0.1-SNAPSHOT.jar || { echo 'JAR not found! Build failed in previous stage?'; exit 1; }"
                    sh "cp ${springBootProjectDir}/build/libs/react-and-spring-data-rest-basic-0.0.1-SNAPSHOT.jar ${dockerBuildDir}/app.jar"
                    echo 'Building Docker image for Spring Boot application...'

                    // Using a specific image tag based on the BUILD_NUMBER
                    dockerImage = docker.build("falmeidaswitch/ca3-spring-app:${env.BUILD_NUMBER}", dockerBuildDir)
                    echo "Docker image built: ${dockerImage.id}"
                }
            }
        }

        stage('Publish Docker Image') {
            steps {
                script {
                    echo 'Publishing Docker image to Docker Hub...'
                    // 'FAlmeida-Switch' must match the ID of your Docker Hub credentials in Jenkins
                    docker.withRegistry('https://registry.hub.docker.com', 'FAlmeida-Switch') {
                        dockerImage.push()
                    }
                    echo "Docker image pushed to Docker Hub."
                }
            }
        }

        stage('Archiving Spring Boot Artifacts') {
            steps {
                dir('CA1/part3/react-and-spring-data-rest-basic') {
                    echo 'Archiving Spring Boot application artifacts...'
                    archiveArtifacts 'build/libs/*.jar'
                }
            }
        }
    }
    post {
        always {
            cleanWs() // Clean up the workspace after the build
        }
    }
}