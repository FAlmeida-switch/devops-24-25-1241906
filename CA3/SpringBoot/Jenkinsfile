// Jenkinsfile for the Spring Boot Application pipeline

pipeline {
    agent { label 'built-in' }

    // Define global environment variables here
    environment {
        DOCKER_IMAGE_BASE_NAME = "falmeidaswitch/ca3-spring-app" // Your Docker Hub repository name
        APP_VERSION = "${env.BUILD_NUMBER}" // Automatically uses Jenkins's build number for versioning
    }

    tools {
        gradle 'gradle_latest'
    }

    stages {
        stage('Checkout Source Code') {
            steps {
                echo 'Checking out Spring Boot application from remote Repository...'
                git branch: 'main', url: 'https://github.com/FAlmeida-switch/devops-24-25-1241906.git'
            }
        }

        stage('Assemble Spring Boot Frontend and Backend') {
            steps {
                script {
                    echo "--- Environment Variables Before Docker Commands ---"
                    sh 'env' // This will print all environment variables
                    echo "----------------------------------------------------"

                    // The DOCKER_IMAGE_BASE_NAME and APP_VERSION are now defined globally.
                    // The 'sh 'docker inspect' command does not directly use these,
                    // so the 'withEnv' block that caused the error is removed here.
                    sh 'docker inspect -f . jenkins/agent:jdk17'
                }
                withDockerContainer(image: "jenkins/agent:jdk17", toolName: 'maven') {
                    // This is where your actual build commands for the Spring Boot app should go.
                    // For example, to build the JAR:
                    dir('CA1/part3/react-and-spring-data-rest-basic') {
                        sh './gradlew assemble' // Or './gradlew build' depending on your needs
                    }
                }
            }
        }

        stage('Test Spring Boot') {
            agent {
                docker image: 'jenkins/agent:jdk17',
                        args: '-v /var/run/docker.sock:/var/run/docker.sock',
                        reuseNode: true
            }
            steps {
                dir('CA1/part3/react-and-spring-data-rest-basic') {
                    echo 'Executing J-unit Tests for Spring Boot...'
                    sh './gradlew test'
                    junit 'build/test-results/test/*.xml'
                }
            }
        }

        stage('Build Docker Image') {
            agent {
                docker image: 'jenkins/agent:jdk17',
                        args: '-v /var/run/docker.sock:/var/run/docker.sock',
                        reuseNode: true
            }
            steps {
                script {
                    echo 'Copying JAR to Docker build context...'
                    def springBootProjectDir = 'CA1/part3/react-and-spring-data-rest-basic'
                    def dockerBuildDir = 'CA3/SpringBoot'

                    sh "test -f ${springBootProjectDir}/build/libs/react-and-spring-data-rest-basic-0.0.1-SNAPSHOT.jar || { echo 'JAR not found! Build failed in previous stage?'; exit 1; }"
                    sh "mkdir -p ${dockerBuildDir}"
                    sh "cp ${springBootProjectDir}/build/libs/react-and-spring-data-rest-basic-0.0.1-SNAPSHOT.jar ${dockerBuildDir}/app.jar"

                    echo 'Building Docker image for Spring Boot application...'
                    // Use the globally defined variables here
                    dockerImage = docker.build("${DOCKER_IMAGE_BASE_NAME}:${APP_VERSION}", dockerBuildDir)
                    echo "Docker image built: ${dockerImage.id}"
                }
            }
        }

        stage('Publish Docker Image') {
            agent {
                docker image: 'jenkins/agent:jdk17',
                        args: '-v /var/run/docker.sock:/var/run/docker.sock',
                        reuseNode: true
            }
            steps {
                script {
                    echo 'Publishing Docker image to Docker Hub...'
                    docker.withRegistry('https://registry.hub.docker.com', 'FAlmeida-Switch') {
                        dockerImage.push()
                    }
                    echo "Docker image pushed to Docker Hub."
                }
            }
        }

        stage('Archiving Spring Boot Artifacts') {
            agent { label 'built-in' }
            steps {
                dir('CA1/part3/react-and-spring-data-rest-basic') {
                    echo 'Archiving Spring Boot application artifacts...'
                    archiveArtifacts 'build/libs/*.jar'
                }
            }
        }
    }
    post {
        always {
            cleanWs()
        }
        failure {
            echo 'Pipeline failed. Check logs for details.'
        }
        success {
            echo 'Pipeline completed successfully!'
        }
    }
}